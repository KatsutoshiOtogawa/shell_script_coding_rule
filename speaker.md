
# シニアエンジニアのためのコーディング規約

前置きすると、
今回説明するのは、ファイルの最後に改行入れるとか、タブはスペース4個分とか。
一般的な意味のコーディング規約という意味じゃないです。
bashにはこういう問題があるから、それを解決するために
こういう書き方にしましょうね。
という話です。

## bashの問題点

簡単に属人化する

bashでなんでこれが起きるかっていうと。
自分は次にあげる理由のせいだと思っています。

## 属人化の原因

1. メンバーの勉強コストが高い状態にしている
2. 書いた人でないとトラブル解決が遅い。

これらの問題を解決するためにはどういう
コーディング方針が必要かというと、
次の方針にしたら解決できます。

## コーディング方針

1. 明示しろ考えさせるな
2. awkやループを使うな

なんでこれで属人化が解消できるかという
説明をしていきます。

### 明示しろ。考えさせるな

1. 突然勉強会が始まるのを防げる

わかりづらい書き方や曖昧な書き方をすると、
他の人が読めないか、これってどういう意味とか
そこで勉強会が始まるんですよ。

この状態だと、そこそこ急ぎだったらその人しかできない。
というケースが多発します。これを防げる。

まだ、プログラミング言語だったら、vscodeの
インテリセンスがすごく賢いので、
このオブジェクトはこう言う意味で、こう言うプロパティがあるから
とか表示してくれるし、
曖昧な書き方や、これはちょっと...と思う書き方は
linterで防げるから、
まだ勉強会の発生が防げるんですが、
bashはインテリセンスが貧弱だし、
メジャーなlinterやtestも無いから、それが厳しい。

特に速度的な差もないし、修正のしやすさも変わらないなら、
明示して曖昧な書き方をなくしたほうがいい。

2. 書いた本人以外でもトラブル解決を早くできる。減らせる

エンジニアが業務理解できていても、
bashがわかりづらい書き方してと読めないと、
書いた人連れてこないときつい。

これは業務的に見てもかなり危険なので、この状態作らないために
できるだけ多くのエンジニアが読みやすいように、明示した方がいい。

### 要点として

要点としては、「明示しろ」というのは結局はソースコードによってコミュニケーションコスト
減らそうぜ！それによって属人化減らそうぜ!という話です。

## awkやループ使うな

ループには欠点がある

1. ループ内には複数の意味を持った処理が入りがちになる
2. ループ回数で変数の状態が変わる

これ欠点なの？とか話になると思うんですが、

特定の処理だけ切り離して、実行してみるが難しい。
ループ内の他の処理の影響をモロに受けるし、
それと合わせて変数が正しい動きをしているか確認する必要がある。

Javaでいうとeclipseのデバッガ使ってループ内のバグ直すために
ステップ実行使って値確認してっていうそういう手段取れないときつい。

その結果どうなるかというと、

## awkやループ使うな2

1. デバッグが難しくなる

では、なぜわざわざbashでループ使っているかっていうと、
変数の状態の違いにより、ifとかcaseとかの制御文で
処理を分けたいっていう狙いがあるケースがあるわけなんですけど、
これも書き方次第ではループを無くすこともできる。

2. 再利用できるとは

次は再利用についてですが、
どういう風にしたらbashを再利用できるか？
っていうと、次のことしたらできることだと思っています。

1. 簡単に関数に切り出せる
2. 対話形式で実行できる
3. 変数名や、オプションなど最低限のものだけ変更したら動く

これやってると何がいいかというと。
何々さんこれちょっとやってもらっていい？
50行目から60業目のやつ参考になると思うから
コピペして、コマンド変えたらできると思う。
わからんかったら聞いて。

こういう風に簡単に運用できるっていうのがいいと思っています。

ビジネスでよく横展開できるかっていうけど、これも小さい意味では
横展開だと自分は思ってて、これをできるだけ増やしたい。

## 要点として

要点としては、awkやループ使うなっていうのは、
使わないことによって、
ソースコードの運用と品質管理を楽にすることにより
属人化を防ごうということです。

たいていの場合は、コマンドとパイプの組み合わせで、
ループ処理が隠蔽できるから、書かなくていいことが多いと思います。

どうしても書いたほうが管理楽とかだったら書いてください。

### じゃあどうするか？っていうと

なぜループを使うかというと、これとifやcaseみたいな条件文と
一緒に描く時があって、特定の値の時に違う処理を書きたいから。

## ここまでの主張まとめ

bashには属人化の問題がある。
属人化の原因

1. コミュニケーションコスト
2. 再利用できない
3. デバッグ難しい

と考えます。

## ここまでの主張まとめ2

次のコーディング方針で対処できそうです。

1. 明示しろ考えさせるな
2. awkやループを使うな

問題がわかった、原因もわかった。対処法もだいたいわかった。
ということで、
これをソースコードに具体的にどうやって落とすのか？
という話をします。

## 具体的なソースコード仕様

例えば、hddの使用率が一定以上の値だったら、
csv形式でリストで表示するというスクリプトを書きたい。
とします。

そしてそれは
これはdfコマンド使ったら書けそう。

例えばdf -h実行して、
(vagrant 上で実行)


このUSEDが指定の値以上の行だけ、表示するコマンドを

## ダメなソースコード

まず、ダメなソースコードから説明します。



名前はdisk_usageという名前のコマンド

これ本に似たようなソースコード書かれているやつあったんですが、
下の本はこれよりもひどいです。

1. set -e

基本的にsetでbashの設定いじるな。

よくあるのが、
とりあえずset -eとかset -eu
とかやっているの

たいていのプログラムはコマンド実行前に失敗するかどうか明確に決まっているか、
強引にエラーが起きうる場所を明示させている。

Java,csharpだったら、try catchしてくれないとビルドの時エラーになるし、
pythonだったら、それよりもルール緩いから、実行時エラーにはならないけど、
公式の例とかみるとみんなtry catch書いてある。

これのおかげで、失敗する可能性がある処理が
誰が見てもわかるようになっているっていうメリットがある。

割と多いんですが、これパッと見た時に
どこがエラー起きる可能性があるのか？とか、
デバッグするならどの時点でのどの変数の値を見ればいいのかとか
わからないと思います。

特にbashはバックアップ取ったり、データの同期取ったり、
osの統計情報の監視とか。
割と失敗したらまあまあやばいこと、
雑にエラー起きたらそこで終了と書かないほうがいいし、
元のbashの動きを変更することはしないほうがいい。

一応set -eを使ったほうがいいパターンもあって、
世の中には読めるけど、人間が触っちゃダメなファイルってあると思うんですよ。
bashから設定ファイルを生成するとかそういうソースコードの場合。
一番わかりやすい例がgrubの設定で、
bashで書いてコマンド実行して設定ファイルを作っているんですよ。
grubで設定ファイルを生成するときに、異常がある設定ファイルで上書き
しない作りにしたいから。

見せると
このbashのスクリプト自体が自動生成されているから、人が直接
触ることないんですよ。
grub自体にバグがあって、自動生成されているスクリプトがおかしいときは
何がなんでも弾きたい。
そういう作りにするんなら、エラーは全部異常終了にしたほうがいいよね？
という考え方です。

たいていのバッチ処理は人間が触ること前提だし、エラー起きても、
エラー以外のところは処理したいとか普通にあるから、
大した理由ないのにいじるべきでない。

set -eもあまり良く無いんですけど、
これよりもっと良く無い
set -euってのがあって、
変数の状態によって、エラーの分岐がある
ということを明示できないんですよ。

環境変数をちゃんと削除することも考えている。
undeclare VARIABLE



2. オプションを必要無いのに変数に分けない

これを見た瞬間にオプションを動的に追加したり、減らしたりするのかな？
もしくは今後そういう処理が追加される予定があるのか？
という疑問が生まれるんですよ。

動的にしたいとしても、
例えば、rsyncでdry-runしたい場合とか、

if [ -z $frewr ]; then
    dry_run="--dry-run"
fi

rsync -av ./ /path/to/disk $dry_run
一部追加するとかそういうぐらいで、


3. ループ使わない

なんでこの人
なんでawk使わないか?
というとこれは
厳密にはスペース区切りのデータじゃないので、awkで綺麗に分割できない。
Mounted on
で一つのカラムだから、カラムにスペース入ってくると面倒臭いことになる。


## じゃあお前の言う書き方

走りになるんですけど、

## 

## 結論

1. 明示しろ考えさせるな
2. awkやループをあまり使うな

ここら辺のコストを運用エンジニアや、後輩が背負うことになるから。
ただ、ソースコード書けました!っていうレベルじゃないし、
もっと他のメンバーがソースコード書けないのは自分のせいにしたほうがいいという話です。

ループを入れるとループ全体としてどうか？
を追わないといけないけど、

パイプで繋げていった場合はコマンドの意味を追っていったら、
必ず、やりたいことが出るようになっている。

一定以上難しい、
愚直に一回でやろうとするとループが発生するもので
ループを避けるコツとしては
検索ロジックと、
結論や表示のロジックを分けることです。

できるだけ、エンジニアに業務理解や、事業としてどうしたいかと
今のシステム的にどうなのか？がどれぐらいかけ離れているかの理解に頭使って欲しい。
