---
title: シニアエンジニアのためのbashコーディング規約
author: KatusothiOtogawa
date: 2022-03-19
---

## 自己紹介

音川 勝俊 \
フリーのバックエンドエンジニア。DB周り、table設計とか。 \
php, python, goとかのバックエンド側のframeworkも普通にわかります。 \
[twitter: @k_otogawa](https://twitter.com/k_otogawa)

## bashの問題点

### 簡単に属人化する

## 属人化の原因

1. メンバーの勉強コストが高い状態にしている
2. 書いた人でないとトラブル解決が遅い。

## コーディング方針

1. 明示しろ考えさせるな
2. awkやループをあまり使うな

## 明示しろ。考えさせるな

1. 突然勉強会が始まるのを防げる
2. 書いた本人以外でもトラブル解決を早くできる。減らせる

## awkやループをあまり使うな

### ループには欠点がある

1. 複数の意味を持った処理が入りがちになる
2. ループ回数で変数の状態が変わる

## awkやループをあまり使うな2

### このせいで何が起きるか

1. デバッグが難しくなる
2. 再利用するのが難しくなる

## 再利用できるとは

### どういう風にしたらbashを再利用できるか？

1. 簡単に関数に切り出せる
2. 対話形式で実行できる
3. 変数名や、オプションなど最低限のものだけ変更したら動く

## ここまでの主張まとめ

### bashには属人化の問題がある

1. メンバーの勉強コストが高い状態にしている
2. 書いた人でないとトラブル解決が遅い。

## ここまでの主張まとめ2

### 次のコーディング方針で対処できそう

1. 明示しろ考えさせるな
2. awkやループをあまり使うな

## 具体的なソースコード仕様

hddの使用率が一定以上の値 -> 行をcsv形式でリストで表示する

名前はdisk_usageという名前のコマンド
dfコマンド使えばいけそう

## 難解な変数展開

a. ${!var}, b. ${var:?}, c. ${var?}

1. setのオプションに関わらず、変数が空、未定義の場合、変数展開時にエラーが起き処理は進む。
2. setのオプションに関わらず、変数が空、未定義の場合、変数展開時にエラーが起き元の場所にreturn。
3. setのオプションの値を見て初めて決まる。
4. setのオプションに関わらず、変数が空、未定義でもエラーは起きない。処理は進む。

## 難解な変数展開2

a. ${!var}, b. ${var:?}, c. ${var?}

5. この中に答えはない。
6. 変数が空、未定義の場合、変数展開時にエラーが起きる。その後の処理がどうなるかはset次第。
7. 変数が未定義の場合、変数展開時にエラーが起きる。その後の処理がどうなるかはset次第。
8. 変数の値が0以外の数字、空、未定義の場合0を返し、それ以外の値の場合は値をそのまま返す。

## 難解な変数展開3

a. ${!var}, b. ${var:?}, c. ${var?}

a -> 5. この中に答えない

b -> 6. 変数が空、未定義の場合、変数展開時にエラーが起きる。その後の処理がどうなるかはset次第。

c -> 7. 変数が未定義の場合、変数展開時にエラーが起きる。その後の処理がどうなるかはset次第。

## 難解な変数展開4

### あまり直感的と思えない

setのオプション次第でプログラミング言語でいう
!の展開だったり、?の展開だったりする。
?だけでも:?と動きも違う。

## set -uを使うメリット

### bashでは特にメリットないです

## -z 変数

空の文字列も未定義の変数も対処できる。直感的

```bash
if [ -z $var ]; then
  echo "" >&2
  return 1  
fi
```

## set -e or set -eu

### 特に意味はない

## ダメなところまとめ

1. set -e使う。どこで出るかわからないエラーは関数内trapでいけるはず。
2. コマンドのオプションを必要無いのに変数に分けない
3. ループ使わない。検索ロジックを分けたら大抵いけるはず

## じゃあ具体的にどういう書き方したら良いか

## 結論1

1. 明示しろ考えさせるな
2. awkやループをあまり使うな

## 結論2

ループが発生しそうになったら

1. 検索ロジックとそれ以外を分けて考えてみる。
2. 一時ファイルに途中の処理を分ける。
3. 一度で全部しようとしない
